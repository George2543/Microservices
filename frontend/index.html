<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>University Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', 'Helvetica', sans-serif;
            background: linear-gradient(to right, #0f2027, #203a43, #2c5364);
            min-height: 100vh;
            padding: 25px;
        }

        .container {
            max-width: 1500px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 20px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        header {
            background: linear-gradient(to right, #1e3c72, #2a5298);
            color: #fff;
            padding: 40px;
            text-align: center;
            border-bottom: 4px solid #f39c12;
        }

        h1 {
            font-size: 2.8em;
            margin-bottom: 12px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.95;
            letter-spacing: 1px;
        }

        .tabs {
            display: flex;
            background: #34495e;
            border-bottom: 3px solid #f39c12;
        }

        .tab {
            flex: 1;
            padding: 22px;
            text-align: center;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.4s;
            border: none;
            background: none;
            font-size: 17px;
            color: #ecf0f1;
        }

        .tab:hover {
            background: #2c3e50;
            color: #f39c12;
        }

        .tab.active {
            background: #ffffff;
            color: #2c3e50;
            border-bottom: 4px solid #e74c3c;
        }

        .content {
            padding: 30px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #bdc3c7;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
            background: #ecf0f1;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #3498db;
            background: #ffffff;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        button {
            background: linear-gradient(to right, #e74c3c, #c0392b);
            color: white;
            padding: 14px 35px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.5);
            background: linear-gradient(to right, #c0392b, #e74c3c);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(to right, #95a5a6, #7f8c8d);
            margin-left: 12px;
        }

        .btn-danger {
            background: linear-gradient(to right, #e74c3c, #c0392b);
        }

        .btn-success {
            background: linear-gradient(to right, #27ae60, #229954);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        th,
        td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: linear-gradient(to right, #34495e, #2c3e50);
            color: #ecf0f1;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        tr:hover {
            background: #ecf0f1;
            transform: scale(1.01);
            transition: all 0.2s;
        }

        .actions {
            display: flex;
            gap: 10px;
        }

        .actions button {
            padding: 8px 15px;
            font-size: 14px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #667eea;
        }

        .circuit-breaker-status {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }

        .status-open {
            background: #dc3545;
            color: white;
        }

        .status-closed {
            background: #28a745;
            color: white;
        }

        .status-half-open {
            background: #ffc107;
            color: #000;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-wrap: wrap;
            }

            .tab {
                flex: 1 1 50%;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>�️ Academic Portal System</h1>
            <p class="subtitle">Enterprise Microservices Platform | Service Registry & Gateway Architecture</p>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('students')">Students</button>
            <button class="tab" onclick="switchTab('professors')">Professors</button>
            <button class="tab" onclick="switchTab('courses')">Courses</button>
            <button class="tab" onclick="switchTab('grades')">Grades</button>
            <button class="tab" onclick="switchTab('circuit-breaker')">Circuit Breaker</button>
        </div>

        <div class="content">
            <!-- Students Section -->
            <div id="students" class="section active">
                <h2>Student Management</h2>
                <div id="student-alert"></div>

                <form id="student-form" onsubmit="saveStudent(event)">
                    <input type="hidden" id="student-id">
                    <div class="form-row">
                        <div class="form-group">
                            <label>First Name *</label>
                            <input type="text" id="student-firstname" required>
                        </div>
                        <div class="form-group">
                            <label>Last Name *</label>
                            <input type="text" id="student-lastname" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Email *</label>
                            <input type="email" id="student-email" required>
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="student-phone">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <input type="text" id="student-address">
                    </div>
                    <button type="submit">Save Student</button>
                    <button type="button" class="btn-secondary" onclick="resetStudentForm()">Reset</button>
                </form>

                <div id="students-list"></div>
            </div>

            <!-- Professors Section -->
            <div id="professors" class="section">
                <h2>Professor Management</h2>
                <div id="professor-alert"></div>

                <form id="professor-form" onsubmit="saveProfessor(event)">
                    <input type="hidden" id="professor-id">
                    <div class="form-row">
                        <div class="form-group">
                            <label>First Name *</label>
                            <input type="text" id="professor-firstname" required>
                        </div>
                        <div class="form-group">
                            <label>Last Name *</label>
                            <input type="text" id="professor-lastname" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Email *</label>
                            <input type="email" id="professor-email" required>
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="professor-phone">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Department *</label>
                        <input type="text" id="professor-department" required>
                    </div>
                    <button type="submit">Save Professor</button>
                    <button type="button" class="btn-secondary" onclick="resetProfessorForm()">Reset</button>
                </form>

                <div id="professors-list"></div>
            </div>

            <!-- Courses Section -->
            <div id="courses" class="section">
                <h2>Course Management</h2>
                <div id="course-alert"></div>

                <form id="course-form" onsubmit="saveCourse(event)">
                    <input type="hidden" id="course-id">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Course Code *</label>
                            <input type="text" id="course-code" required>
                        </div>
                        <div class="form-group">
                            <label>Course Name *</label>
                            <input type="text" id="course-name" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="course-description"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Credits *</label>
                            <input type="number" id="course-credits" required min="1" max="10">
                        </div>
                        <div class="form-group">
                            <label>Department *</label>
                            <input type="text" id="course-department" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Semester</label>
                        <input type="text" id="course-semester" placeholder="e.g., Fall 2025">
                    </div>
                    <button type="submit">Save Course</button>
                    <button type="button" class="btn-secondary" onclick="resetCourseForm()">Reset</button>
                </form>

                <div id="courses-list"></div>
            </div>

            <!-- Grades Section -->
            <div id="grades" class="section">
                <h2>Grade Management</h2>
                <div id="grade-alert"></div>

                <form id="grade-form" onsubmit="saveGrade(event)">
                    <input type="hidden" id="grade-id">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Student ID *</label>
                            <input type="number" id="grade-studentid" required>
                        </div>
                        <div class="form-group">
                            <label>Course ID *</label>
                            <input type="number" id="grade-courseid" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Grade Value (0-100) *</label>
                        <input type="number" id="grade-value" required min="0" max="100" step="0.01">
                    </div>
                    <button type="submit">Save Grade</button>
                    <button type="button" class="btn-secondary" onclick="resetGradeForm()">Reset</button>
                </form>

                <div id="grades-list"></div>
            </div>

            <!-- Circuit Breaker Section -->
            <div id="circuit-breaker" class="section">
                <h2>Circuit Breaker Demo</h2>
                <div class="circuit-breaker-status">
                    <h3>Test Circuit Breaker Pattern</h3>
                    <p>The Student Service has a circuit breaker protecting calls to the Grading Service.
                        You can test the fallback behavior by stopping the Grading Service.</p>
                </div>

                <div class="form-group">
                    <label>Select Student to View Grades:</label>
                    <select id="cb-student-select">
                        <option value="">-- Select Student --</option>
                    </select>
                </div>
                <button onclick="testCircuitBreaker()">Test Circuit Breaker</button>
                <button class="btn-secondary" onclick="checkCircuitBreakerHealth()">Check Health</button>

                <div id="circuit-breaker-result" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = window.__API_BASE_URL__ || '';

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            // Load data when switching tabs
            switch (tabName) {
                case 'students':
                    loadStudents();
                    break;
                case 'professors':
                    loadProfessors();
                    break;
                case 'courses':
                    loadCourses();
                    break;
                case 'grades':
                    loadGrades();
                    break;
                case 'circuit-breaker':
                    loadStudentsForCircuitBreaker();
                    break;
            }
        }

        // Alert functions
        function showAlert(containerId, message, type) {
            const alertDiv = document.getElementById(containerId);
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => alertDiv.innerHTML = '', 5000);
        }

        // ===== STUDENTS =====
        async function loadStudents() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/students`);
                const students = await response.json();

                let html = '<table><thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Phone</th><th>Address</th><th>Actions</th></tr></thead><tbody>';

                students.forEach(student => {
                    html += `
                        <tr>
                            <td>${student.id}</td>
                            <td>${student.firstName} ${student.lastName}</td>
                            <td>${student.email}</td>
                            <td>${student.phone || '-'}</td>
                            <td>${student.address || '-'}</td>
                            <td class="actions">
                                <button class="btn-success" onclick="viewStudentGrades(${student.id})">View Grades</button>
                                <button onclick="editStudent(${student.id})">Edit</button>
                                <button class="btn-danger" onclick="deleteStudent(${student.id})">Delete</button>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                document.getElementById('students-list').innerHTML = html;
            } catch (error) {
                showAlert('student-alert', 'Error loading students: ' + error.message, 'error');
            }
        }

        async function saveStudent(event) {
            event.preventDefault();

            const id = document.getElementById('student-id').value;
            const student = {
                firstName: document.getElementById('student-firstname').value,
                lastName: document.getElementById('student-lastname').value,
                email: document.getElementById('student-email').value,
                phone: document.getElementById('student-phone').value,
                address: document.getElementById('student-address').value
            };

            try {
                const url = id ? `${API_BASE_URL}/api/students/${id}` : `${API_BASE_URL}/api/students`;
                const method = id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(student)
                });

                if (response.ok) {
                    showAlert('student-alert', `Student ${id ? 'updated' : 'created'} successfully!`, 'success');
                    resetStudentForm();
                    loadStudents();
                } else {
                    throw new Error('Failed to save student');
                }
            } catch (error) {
                showAlert('student-alert', 'Error saving student: ' + error.message, 'error');
            }
        }

        async function editStudent(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/students/${id}`);
                const student = await response.json();

                document.getElementById('student-id').value = student.id;
                document.getElementById('student-firstname').value = student.firstName;
                document.getElementById('student-lastname').value = student.lastName;
                document.getElementById('student-email').value = student.email;
                document.getElementById('student-phone').value = student.phone || '';
                document.getElementById('student-address').value = student.address || '';
            } catch (error) {
                showAlert('student-alert', 'Error loading student: ' + error.message, 'error');
            }
        }

        async function deleteStudent(id) {
            if (!confirm('Are you sure you want to delete this student?')) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/students/${id}`, { method: 'DELETE' });

                if (response.ok) {
                    showAlert('student-alert', 'Student deleted successfully!', 'success');
                    loadStudents();
                } else {
                    throw new Error('Failed to delete student');
                }
            } catch (error) {
                showAlert('student-alert', 'Error deleting student: ' + error.message, 'error');
            }
        }

        function resetStudentForm() {
            document.getElementById('student-form').reset();
            document.getElementById('student-id').value = '';
        }

        async function viewStudentGrades(studentId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/students/${studentId}/grades`);
                const grades = await response.json();

                if (grades.length === 0) {
                    showAlert('student-alert', 'No grades found for this student.', 'error');
                } else {
                    let message = `Grades for Student ${studentId}:\n`;
                    grades.forEach(grade => {
                        message += `Course ID: ${grade.courseId}, Grade: ${grade.gradeValue} (${grade.letterGrade})\n`;
                    });
                    alert(message);
                }
            } catch (error) {
                showAlert('student-alert', 'Error loading grades (Circuit Breaker may be open): ' + error.message, 'error');
            }
        }

        // ===== PROFESSORS =====
        async function loadProfessors() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/professors`);
                const professors = await response.json();

                let html = '<table><thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Department</th><th>Phone</th><th>Actions</th></tr></thead><tbody>';

                professors.forEach(prof => {
                    html += `
                        <tr>
                            <td>${prof.id}</td>
                            <td>${prof.firstName} ${prof.lastName}</td>
                            <td>${prof.email}</td>
                            <td>${prof.department}</td>
                            <td>${prof.phone || '-'}</td>
                            <td class="actions">
                                <button onclick="editProfessor(${prof.id})">Edit</button>
                                <button class="btn-danger" onclick="deleteProfessor(${prof.id})">Delete</button>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                document.getElementById('professors-list').innerHTML = html;
            } catch (error) {
                showAlert('professor-alert', 'Error loading professors: ' + error.message, 'error');
            }
        }

        async function saveProfessor(event) {
            event.preventDefault();

            const id = document.getElementById('professor-id').value;
            const professor = {
                firstName: document.getElementById('professor-firstname').value,
                lastName: document.getElementById('professor-lastname').value,
                email: document.getElementById('professor-email').value,
                phone: document.getElementById('professor-phone').value,
                department: document.getElementById('professor-department').value
            };

            try {
                const url = id ? `${API_BASE_URL}/api/professors/${id}` : `${API_BASE_URL}/api/professors`;
                const method = id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(professor)
                });

                if (response.ok) {
                    showAlert('professor-alert', `Professor ${id ? 'updated' : 'created'} successfully!`, 'success');
                    resetProfessorForm();
                    loadProfessors();
                } else {
                    throw new Error('Failed to save professor');
                }
            } catch (error) {
                showAlert('professor-alert', 'Error saving professor: ' + error.message, 'error');
            }
        }

        async function editProfessor(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/professors/${id}`);
                const professor = await response.json();

                document.getElementById('professor-id').value = professor.id;
                document.getElementById('professor-firstname').value = professor.firstName;
                document.getElementById('professor-lastname').value = professor.lastName;
                document.getElementById('professor-email').value = professor.email;
                document.getElementById('professor-phone').value = professor.phone || '';
                document.getElementById('professor-department').value = professor.department;
            } catch (error) {
                showAlert('professor-alert', 'Error loading professor: ' + error.message, 'error');
            }
        }

        async function deleteProfessor(id) {
            if (!confirm('Are you sure you want to delete this professor?')) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/professors/${id}`, { method: 'DELETE' });

                if (response.ok) {
                    showAlert('professor-alert', 'Professor deleted successfully!', 'success');
                    loadProfessors();
                } else {
                    throw new Error('Failed to delete professor');
                }
            } catch (error) {
                showAlert('professor-alert', 'Error deleting professor: ' + error.message, 'error');
            }
        }

        function resetProfessorForm() {
            document.getElementById('professor-form').reset();
            document.getElementById('professor-id').value = '';
        }

        // ===== COURSES =====
        async function loadCourses() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/courses`);
                const courses = await response.json();

                let html = '<table><thead><tr><th>ID</th><th>Code</th><th>Name</th><th>Credits</th><th>Department</th><th>Semester</th><th>Actions</th></tr></thead><tbody>';

                courses.forEach(course => {
                    html += `
                        <tr>
                            <td>${course.id}</td>
                            <td>${course.code}</td>
                            <td>${course.name}</td>
                            <td>${course.credits}</td>
                            <td>${course.department}</td>
                            <td>${course.semester || '-'}</td>
                            <td class="actions">
                                <button onclick="editCourse('${course.id}')">Edit</button>
                                <button class="btn-danger" onclick="deleteCourse('${course.id}')">Delete</button>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                document.getElementById('courses-list').innerHTML = html;
            } catch (error) {
                showAlert('course-alert', 'Error loading courses: ' + error.message, 'error');
            }
        }

        async function saveCourse(event) {
            event.preventDefault();

            const id = document.getElementById('course-id').value;
            const course = {
                code: document.getElementById('course-code').value,
                name: document.getElementById('course-name').value,
                description: document.getElementById('course-description').value,
                credits: parseInt(document.getElementById('course-credits').value),
                department: document.getElementById('course-department').value,
                semester: document.getElementById('course-semester').value
            };

            try {
                const url = id ? `${API_BASE_URL}/api/courses/${id}` : `${API_BASE_URL}/api/courses`;
                const method = id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(course)
                });

                if (response.ok) {
                    showAlert('course-alert', `Course ${id ? 'updated' : 'created'} successfully!`, 'success');
                    resetCourseForm();
                    loadCourses();
                } else {
                    throw new Error('Failed to save course');
                }
            } catch (error) {
                showAlert('course-alert', 'Error saving course: ' + error.message, 'error');
            }
        }

        async function editCourse(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/courses/${id}`);
                const course = await response.json();

                document.getElementById('course-id').value = course.id;
                document.getElementById('course-code').value = course.code;
                document.getElementById('course-name').value = course.name;
                document.getElementById('course-description').value = course.description || '';
                document.getElementById('course-credits').value = course.credits;
                document.getElementById('course-department').value = course.department;
                document.getElementById('course-semester').value = course.semester || '';
            } catch (error) {
                showAlert('course-alert', 'Error loading course: ' + error.message, 'error');
            }
        }

        async function deleteCourse(id) {
            if (!confirm('Are you sure you want to delete this course?')) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/courses/${id}`, { method: 'DELETE' });

                if (response.ok) {
                    showAlert('course-alert', 'Course deleted successfully!', 'success');
                    loadCourses();
                } else {
                    throw new Error('Failed to delete course');
                }
            } catch (error) {
                showAlert('course-alert', 'Error deleting course: ' + error.message, 'error');
            }
        }

        function resetCourseForm() {
            document.getElementById('course-form').reset();
            document.getElementById('course-id').value = '';
        }

        // ===== GRADES =====
        async function loadGrades() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/grades`);
                const grades = await response.json();

                let html = '<table><thead><tr><th>ID</th><th>Student ID</th><th>Course ID</th><th>Grade Value</th><th>Letter Grade</th><th>Actions</th></tr></thead><tbody>';

                grades.forEach(grade => {
                    html += `
                        <tr>
                            <td>${grade.id}</td>
                            <td>${grade.studentId}</td>
                            <td>${grade.courseId}</td>
                            <td>${grade.gradeValue}</td>
                            <td><strong>${grade.letterGrade}</strong></td>
                            <td class="actions">
                                <button onclick="editGrade(${grade.id})">Edit</button>
                                <button class="btn-danger" onclick="deleteGrade(${grade.id})">Delete</button>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                document.getElementById('grades-list').innerHTML = html;
            } catch (error) {
                showAlert('grade-alert', 'Error loading grades: ' + error.message, 'error');
            }
        }

        async function saveGrade(event) {
            event.preventDefault();

            const id = document.getElementById('grade-id').value;
            const grade = {
                studentId: parseInt(document.getElementById('grade-studentid').value),
                courseId: parseInt(document.getElementById('grade-courseid').value),
                gradeValue: parseFloat(document.getElementById('grade-value').value)
            };

            try {
                const url = id ? `${API_BASE_URL}/api/grades/${id}` : `${API_BASE_URL}/api/grades`;
                const method = id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(grade)
                });

                if (response.ok) {
                    showAlert('grade-alert', `Grade ${id ? 'updated' : 'created'} successfully!`, 'success');
                    resetGradeForm();
                    loadGrades();
                } else {
                    throw new Error('Failed to save grade');
                }
            } catch (error) {
                showAlert('grade-alert', 'Error saving grade: ' + error.message, 'error');
            }
        }

        async function editGrade(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/grades/${id}`);
                const grade = await response.json();

                document.getElementById('grade-id').value = grade.id;
                document.getElementById('grade-studentid').value = grade.studentId;
                document.getElementById('grade-courseid').value = grade.courseId;
                document.getElementById('grade-value').value = grade.gradeValue;
            } catch (error) {
                showAlert('grade-alert', 'Error loading grade: ' + error.message, 'error');
            }
        }

        async function deleteGrade(id) {
            if (!confirm('Are you sure you want to delete this grade?')) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/grades/${id}`, { method: 'DELETE' });

                if (response.ok) {
                    showAlert('grade-alert', 'Grade deleted successfully!', 'success');
                    loadGrades();
                } else {
                    throw new Error('Failed to delete grade');
                }
            } catch (error) {
                showAlert('grade-alert', 'Error deleting grade: ' + error.message, 'error');
            }
        }

        function resetGradeForm() {
            document.getElementById('grade-form').reset();
            document.getElementById('grade-id').value = '';
        }

        // ===== CIRCUIT BREAKER =====
        async function loadStudentsForCircuitBreaker() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/students`);
                const students = await response.json();

                const select = document.getElementById('cb-student-select');
                select.innerHTML = '<option value="">-- Select Student --</option>';

                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = `${student.id} - ${student.firstName} ${student.lastName}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }

        async function testCircuitBreaker() {
            const studentId = document.getElementById('cb-student-select').value;
            if (!studentId) {
                alert('Please select a student first');
                return;
            }

            const resultDiv = document.getElementById('circuit-breaker-result');
            resultDiv.innerHTML = '<div class="loading">Testing Circuit Breaker...</div>';

            try {
                const response = await fetch(`${API_BASE_URL}/api/students/${studentId}/grades`);
                const grades = await response.json();

                let html = '<div class="circuit-breaker-status">';
                html += '<h3>✅ Circuit Breaker Status: CLOSED</h3>';
                html += '<p>The Grading Service is responding normally.</p>';
                html += '<h4>Grades Retrieved:</h4>';

                if (grades.length === 0) {
                    html += '<p>No grades found for this student.</p>';
                } else {
                    html += '<table><thead><tr><th>Course ID</th><th>Grade Value</th><th>Letter Grade</th></tr></thead><tbody>';
                    grades.forEach(grade => {
                        html += `<tr><td>${grade.courseId}</td><td>${grade.gradeValue}</td><td><strong>${grade.letterGrade}</strong></td></tr>`;
                    });
                    html += '</tbody></table>';
                }
                html += '</div>';

                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="circuit-breaker-status">
                        <h3>⚠️ Circuit Breaker Status: OPEN</h3>
                        <p>The Grading Service is not responding. The circuit breaker has activated the fallback method.</p>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p>The Student Service is still functioning, but grade data is unavailable.</p>
                        <p><em>To fix this, ensure the Grading Service is running.</em></p>
                    </div>
                `;
            }
        }

        async function checkCircuitBreakerHealth() {
            const resultDiv = document.getElementById('circuit-breaker-result');
            resultDiv.innerHTML = '<div class="loading">Checking health...</div>';

            try {
                const response = await fetch(`${API_BASE_URL}/api/students/actuator/health`);
                const health = await response.json();

                let html = '<div class="circuit-breaker-status">';
                html += '<h3>Health Check Results</h3>';
                html += '<pre>' + JSON.stringify(health, null, 2) + '</pre>';
                html += '</div>';

                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-error">Error checking health: ${error.message}</div>`;
            }
        }

        // Initial load
        loadStudents();
    </script>
</body>

</html>